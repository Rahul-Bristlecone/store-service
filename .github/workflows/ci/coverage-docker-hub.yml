name: Coverage (Docker image from Hub)

on:
  workflow_run:
    workflows: [ "Build & Push Image" ]
    types: [ completed ]

jobs:
  coverage-from-image:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Log in to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 2️⃣ Pull the exact image built for the triggering commit
      - name: Pull image from Docker Hub
        run: docker pull ${{ secrets.DOCKERHUB_USERNAME }}/myapp:${{ github.event.workflow_run.head_sha }}

      # 3️⃣ Run coverage inside the container and write coverage.xml to a mounted path on the host
      #    We mount only an artifacts directory so code under test remains the one inside the image.
      - name: Run coverage in container
        run: |
          mkdir -p artifacts
          docker run --rm \
            -v ${{ github.workspace }}/artifacts:/artifacts \
            ${{ secrets.DOCKERHUB_USERNAME }}/myapp:${{ github.event.workflow_run.head_sha }} \
            /bin/sh -lc "python -m pip install --upgrade pip && pip install coverage pytest && coverage run -m pytest && coverage xml -o /artifacts/coverage.xml"

      # 4️⃣ Upload coverage artifact
      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: artifacts/coverage.xml