# syntax=docker/dockerfile:1

FROM python:3.12-slim AS base
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1
WORKDIR /app

############################
# Deps (runtime)
############################
FROM base AS deps
COPY requirements.txt .
RUN python -m venv /opt/venv && . /opt/venv/bin/activate && pip install -r requirements.txt
ENV PATH="/opt/venv/bin:$PATH"

############################
# Test stage
############################
FROM deps AS ci
# Dev/test deps
COPY requirements-dev.txt .
RUN pip install -r requirements-dev.txt

# Copy app and tests
COPY src ./src
COPY tests ./tests
COPY main.py run.py ./
# Optional: if tests need app entrypoint files, migrations, etc.
# COPY migrations ./migrations

# By default we don't RUN pytest here (to allow compose to orchestrate DB first).
# We'll run pytest as the container command when the DB is healthy.
CMD ["pytest", "-q", "--maxfail=1", "--disable-warnings"]

############################
# Final runtime
############################
FROM python:3.12-slim AS prod
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1
WORKDIR /app

COPY --from=deps /opt/venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Copy only runtime code (no tests)
COPY src ./src
COPY main.py run.py ./

# Adjust to your actual entrypoint
EXPOSE 5000
CMD ["python", "-m", "run.py"]